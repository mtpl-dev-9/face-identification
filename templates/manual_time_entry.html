{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col-12">
    <h2><i class="fas fa-user-clock"></i> Manual Time Entry Management</h2>
    <p class="text-muted">Admin can manually add user check-in, check-out, break-in, break-out times and working dates.</p>
  </div>
</div>

<div class="row mt-4">
  <!-- Add Entry Form -->
  <div class="col-md-5">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Add Manual Time Entry</h5>
      </div>
      <div class="card-body">
        <form id="addEntryForm">
          <div class="mb-3">
            <label class="form-label">User <span class="text-danger">*</span></label>
            <select class="form-select" id="userId" required>
              <option value="">Select User...</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Working Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="workingDate" required>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Check-In Time</label>
              <input type="time" class="form-control" id="checkInTime">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Check-Out Time</label>
              <input type="time" class="form-control" id="checkOutTime">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Break-In Time</label>
              <input type="time" class="form-control" id="breakInTime">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Break-Out Time</label>
              <input type="time" class="form-control" id="breakOutTime">
            </div>
          </div>
          
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Save Entry
            </button>
          </div>
        </form>
        
        <div id="formStatus" class="alert mt-3" style="display:none;"></div>
      </div>
    </div>
    
    <!-- Filters -->
    <div class="card shadow mt-3">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="fas fa-filter"></i> Filters</h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">User</label>
          <select class="form-select" id="filterUserId">
            <option value="">All Users</option>
          </select>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-control" id="filterStartDate">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">End Date</label>
            <input type="date" class="form-control" id="filterEndDate">
          </div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="loadEntries()">
          <i class="fas fa-search"></i> Apply Filters
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="clearFilters()">
          <i class="fas fa-times"></i> Clear Filters
        </button>
      </div>
    </div>
  </div>
  
  <!-- Entries Table -->
  <div class="col-md-7">
    <div class="card shadow">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-list"></i> Time Entries</h5>
        <button type="button" class="btn btn-sm btn-light" onclick="loadEntries()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
      <div class="card-body">
        <div id="entriesTableContainer">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let users = [];
let entries = [];

// Load users on page load
async function loadUsers() {
  try {
    const res = await fetch('/api/users');
    const data = await res.json();
    if (data.success) {
      users = data.users;
      const userIdSelect = document.getElementById('userId');
      const filterUserIdSelect = document.getElementById('filterUserId');
      
      // Clear existing options except first
      userIdSelect.innerHTML = '<option value="">Select User...</option>';
      filterUserIdSelect.innerHTML = '<option value="">All Users</option>';
      
      users.forEach(user => {
        const option1 = document.createElement('option');
        option1.value = user.user_id;
        option1.textContent = `${user.name} (${user.employee_code})`;
        userIdSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = user.user_id;
        option2.textContent = `${user.name} (${user.employee_code})`;
        filterUserIdSelect.appendChild(option2);
      });
    }
  } catch (error) {
    console.error('Error loading users:', error);
  }
}

// Load entries
async function loadEntries() {
  const container = document.getElementById('entriesTableContainer');
  container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
  
  try {
    const params = new URLSearchParams();
    const filterUserId = document.getElementById('filterUserId').value;
    const filterStartDate = document.getElementById('filterStartDate').value;
    const filterEndDate = document.getElementById('filterEndDate').value;
    
    if (filterUserId) params.append('user_id', filterUserId);
    if (filterStartDate) params.append('start_date', filterStartDate);
    if (filterEndDate) params.append('end_date', filterEndDate);
    
    const res = await fetch(`/api/manual-time-entries?${params.toString()}`);
    const data = await res.json();
    
    if (data.success) {
      entries = data.entries;
      renderEntries();
    } else {
      container.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Failed to load entries'}</div>`;
    }
  } catch (error) {
    container.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
  }
}

// Render entries table
function renderEntries() {
  const container = document.getElementById('entriesTableContainer');
  
  if (entries.length === 0) {
    container.innerHTML = '<div class="alert alert-info">No time entries found.</div>';
    return;
  }
  
  let html = `
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>User</th>
            <th>Date</th>
            <th>Check-In</th>
            <th>Check-Out</th>
            <th>Break-In</th>
            <th>Break-Out</th>
            <th>Work Hours</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  entries.forEach(entry => {
    html += `
      <tr>
        <td>
          <strong>${entry.user_name}</strong><br>
          <small class="text-muted">${entry.employee_code}</small>
        </td>
        <td>${formatDate(entry.working_date)}</td>
        <td>${entry.check_in_time || '-'}</td>
        <td>${entry.check_out_time || '-'}</td>
        <td>${entry.break_in_time || '-'}</td>
        <td>${entry.break_out_time || '-'}</td>
        <td>
          ${entry.work_hours !== null ? `<strong class="text-success">${entry.work_hours}h</strong>` : '-'}
        </td>
        <td>
          <button class="btn btn-sm btn-danger" onclick="deleteEntry(${entry.id})" title="Delete">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
    <div class="mt-3">
      <small class="text-muted">Total entries: ${entries.length}</small>
    </div>
  `;
  
  container.innerHTML = html;
}

// Format date
function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

// Clear filters
function clearFilters() {
  document.getElementById('filterUserId').value = '';
  document.getElementById('filterStartDate').value = '';
  document.getElementById('filterEndDate').value = '';
  loadEntries();
}

// Delete entry
async function deleteEntry(entryId) {
  if (!confirm('Are you sure you want to delete this entry?')) {
    return;
  }
  
  try {
    const res = await fetch(`/api/manual-time-entries/${entryId}`, {
      method: 'DELETE'
    });
    const data = await res.json();
    
    if (data.success) {
      showFormStatus('Entry deleted successfully', 'success');
      loadEntries();
    } else {
      showFormStatus(`Error: ${data.error}`, 'danger');
    }
  } catch (error) {
    showFormStatus(`Error: ${error.message}`, 'danger');
  }
}

// Form submission
document.getElementById('addEntryForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const userId = document.getElementById('userId').value;
  const workingDate = document.getElementById('workingDate').value;
  const checkInTime = document.getElementById('checkInTime').value;
  const checkOutTime = document.getElementById('checkOutTime').value;
  const breakInTime = document.getElementById('breakInTime').value;
  const breakOutTime = document.getElementById('breakOutTime').value;
  
  if (!userId || !workingDate) {
    showFormStatus('User and Working Date are required', 'danger');
    return;
  }
  
  const data = {
  user_id: parseInt(userId),
  working_date: workingDate,
  check_in_time: checkInTime || null,
  check_out_time: checkOutTime || null,
  break_in_time: breakInTime || null,
  break_out_time: breakOutTime || null,
  created_by: 1   // use the correct userId: 1=Admin, 4=Manager, etc.
};
console.log('Sending payload:', data);
  
  // Remove null values
  Object.keys(data).forEach(key => {
    if (data[key] === null || data[key] === '') {
      delete data[key];
    }
  });
  
  try {
    const res = await fetch('/api/manual-time-entries', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await res.json();
    
    if (result.success) {
      showFormStatus('Entry added successfully!', 'success');
      document.getElementById('addEntryForm').reset();
      loadEntries();
    } else {
      showFormStatus(`Error: ${result.error}`, 'danger');
    }
  } catch (error) {
    showFormStatus(`Error: ${error.message}`, 'danger');
  }
});

// Show form status
function showFormStatus(message, type) {
  const statusDiv = document.getElementById('formStatus');
  statusDiv.className = `alert alert-${type}`;
  statusDiv.textContent = message;
  statusDiv.style.display = 'block';
  setTimeout(() => {
    statusDiv.style.display = 'none';
  }, 5000);
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadUsers();
  loadEntries();
  
  // Set default date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('workingDate').value = today;
});
</script>

{% endblock %}

