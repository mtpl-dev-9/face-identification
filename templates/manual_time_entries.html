{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">Manual Time Entries</h3>

<div class="row mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">Add / Update Entry</h5>
        <form id="manual-time-form">
          <div class="mb-2">
            <label class="form-label">User</label>
            <select class="form-select" id="mt-user-id" required>
              <option value="">Select user</option>
              {% for u in users %}
              <option value="{{ u.userId }}">{{ (u.userFirstName or '') ~ ' ' ~ (u.userLastName or '') }} ({{ u.userLogin or u.userId }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" id="mt-date" required>
          </div>
          <div class="row">
            <div class="col-6 mb-2">
              <label class="form-label">Check-in</label>
              <input type="time" class="form-control" id="mt-check-in">
            </div>
            <div class="col-6 mb-2">
              <label class="form-label">Check-out</label>
              <input type="time" class="form-control" id="mt-check-out">
            </div>
          </div>
          <div class="row">
            <div class="col-6 mb-2">
              <label class="form-label">Break-in</label>
              <input type="time" class="form-control" id="mt-break-in">
            </div>
            <div class="col-6 mb-3">
              <label class="form-label">Break-out</label>
              <input type="time" class="form-control" id="mt-break-out">
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-save"></i> Save
          </button>
          <div id="mt-form-message" class="mt-2 small"></div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="card-title mb-0">Entries</h5>
          <div class="d-flex gap-2">
            <input type="date" class="form-control form-control-sm" id="mt-filter-from" placeholder="From">
            <input type="date" class="form-control form-control-sm" id="mt-filter-to" placeholder="To">
            <button class="btn btn-sm btn-outline-secondary" id="mt-filter-apply" type="button">
              <i class="fas fa-filter"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" id="mt-filter-clear" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-sm mb-0" id="mt-table">
            <thead>
              <tr>
                <th>#</th>
                <th>User</th>
                <th>Date</th>
                <th>Check-in</th>
                <th>Check-out</th>
                <th>Break-in</th>
                <th>Break-out</th>
              </tr>
            </thead>
            <tbody id="mt-tbody">
              <tr><td colspan="7" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("manual-time-form");
  const msgEl = document.getElementById("mt-form-message");
  const tbody = document.getElementById("mt-tbody");
  const filterFrom = document.getElementById("mt-filter-from");
  const filterTo = document.getElementById("mt-filter-to");
  const filterBtn = document.getElementById("mt-filter-apply");
  const filterClearBtn = document.getElementById("mt-filter-clear");

  function showMessage(text, isError) {
    msgEl.textContent = text;
    msgEl.className = "mt-2 small " + (isError ? "text-danger" : "text-success");
  }

  async function loadEntries() {
    tbody.innerHTML = "<tr><td colspan='7' class='text-center'>Loading...</td></tr>";
    const params = new URLSearchParams();
    if (filterFrom.value) params.append("from_date", filterFrom.value);
    if (filterTo.value) params.append("to_date", filterTo.value);
    const res = await fetch("/api/manual-time-entries?" + params.toString());
    const data = await res.json();
    if (!data.success) {
      tbody.innerHTML = "<tr><td colspan='7' class='text-center text-danger'>" + (data.error || "Failed to load") + "</td></tr>";
      return;
    }
    if (!data.entries.length) {
      tbody.innerHTML = "<tr><td colspan='7' class='text-center'>No entries found.</td></tr>";
      return;
    }
    tbody.innerHTML = "";
    data.entries.forEach((e, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${e.user_name || ""} <small class="text-muted">(${e.employee_code || e.user_id})</small></td>
        <td>${e.working_date || ""}</td>
        <td>${e.check_in_time || "-"}</td>
        <td>${e.check_out_time || "-"}</td>
        <td>${e.break_in_time || "-"}</td>
        <td>${e.break_out_time || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  form.addEventListener("submit", async function (ev) {
    ev.preventDefault();
    showMessage("", false);

    const payload = {
      user_id: parseInt(document.getElementById("mt-user-id").value || "0", 10),
      working_date: document.getElementById("mt-date").value,
      check_in_time: document.getElementById("mt-check-in").value || null,
      check_out_time: document.getElementById("mt-check-out").value || null,
      break_in_time: document.getElementById("mt-break-in").value || null,
      break_out_time: document.getElementById("mt-break-out").value || null,
    };

    if (!payload.user_id || !payload.working_date) {
      showMessage("User and date are required", true);
      return;
    }

    const res = await fetch("/api/manual-time-entries", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    if (!data.success) {
      showMessage(data.error || "Failed to save entry", true);
      return;
    }
    showMessage("Entry saved successfully", false);
    loadEntries();
  });

  filterBtn.addEventListener("click", function () {
    loadEntries();
  });

  filterClearBtn.addEventListener("click", function () {
    filterFrom.value = "";
    filterTo.value = "";
    loadEntries();
  });

  loadEntries();
});
</script>
{% endblock %}


