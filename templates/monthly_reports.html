{% extends "base.html" %}
{% block title %}Monthly Reports{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>Monthly Attendance Reports</h2>
    
    <div class="card mb-4">
        <div class="card-body">
            <h5>Generate Report</h5>
            <div class="row">
                <div class="col-md-4">
                    <label>User</label>
                    <select id="userId" class="form-control">
                        <option value="">Select User</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>Month</label>
                    <select id="month" class="form-control">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>Year</label>
                    <input type="number" id="year" class="form-control" value="2025">
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button onclick="generateReport()" class="btn btn-primary btn-block">Generate</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reportCard" class="card" style="display:none;">
        <div class="card-body">
            <h5 id="reportTitle"></h5>
            <table class="table table-bordered">
                <tr><th>Total Working Hours</th><td id="totalHours"></td></tr>
                <tr><th>Worked Days</th><td id="workedDays"></td></tr>
                <tr><th>Weekly Offs</th><td id="weeklyOffs"></td></tr>
                <tr><th>Holidays</th><td id="holidays"></td></tr>
                <tr><th>Leaves Taken</th><td id="leavesTaken"></td></tr>
                <tr><th>Leave Details</th><td id="leaveDetails"></td></tr>
                <tr><th>On-Time Entries</th><td id="onTime"></td></tr>
                <tr><th>Late Entries</th><td id="lateIn"></td></tr>
                <tr><th>Early Outs</th><td id="earlyOut"></td></tr>
                <tr><th>Absent Days</th><td id="absentDays"></td></tr>
            </table>
        </div>
    </div>
</div>

<script>
async function loadUsers() {
    const res = await fetch('/api/users');
    const data = await res.json();
    const select = document.getElementById('userId');
    data.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.user_id;
        opt.textContent = `${u.name} (${u.employee_code})`;
        select.appendChild(opt);
    });
}

async function generateReport() {
    const userId = document.getElementById('userId').value;
    const month = document.getElementById('month').value;
    const year = document.getElementById('year').value;
    
    if (!userId) {
        alert('Please select a user');
        return;
    }
    
    const res = await fetch(`/api/attendance/monthly-report?user_id=${userId}&month=${month}&year=${year}`);
    const data = await res.json();
    
    if (data.success) {
        const r = data.report;
        document.getElementById('reportTitle').textContent = `Report for ${getMonthName(month)} ${year}`;
        document.getElementById('totalHours').textContent = r.total_working_hours + ' hrs';
        document.getElementById('workedDays').textContent = r.worked_days;
        document.getElementById('weeklyOffs').textContent = r.total_weekly_off;
        document.getElementById('holidays').textContent = r.holidays;
        document.getElementById('leavesTaken').textContent = r.leaves_taken;
        
        let leaveHtml = '';
        if (r.leave_details && r.leave_details.length > 0) {
            r.leave_details.forEach(l => {
                const badge = l.is_paid ? '<span class="badge badge-success">Paid</span>' : '<span class="badge badge-secondary">Unpaid</span>';
                leaveHtml += `<div>${l.type}: ${l.days} days ${badge}</div>`;
            });
        } else {
            leaveHtml = 'No leaves taken';
        }
        document.getElementById('leaveDetails').innerHTML = leaveHtml;
        document.getElementById('onTime').textContent = r.on_time_entries;
        document.getElementById('lateIn').textContent = r.late_in;
        document.getElementById('earlyOut').textContent = r.early_out;
        document.getElementById('absentDays').textContent = r.absent_days;
        document.getElementById('reportCard').style.display = 'block';
    } else {
        alert('Error: ' + data.error);
    }
}

function getMonthName(m) {
    const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    return months[parseInt(m)];
}

loadUsers();
const now = new Date();
document.getElementById('month').value = now.getMonth() + 1;
document.getElementById('year').value = now.getFullYear();
</script>
{% endblock %}
